<!DOCTYPE html>
<html>
	<head>
		<!--- 

			bootstrap css is auto injected by the parent frame

			<link id="cssChanges" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"> 

		---->
		<meta charset="utf-8" />
		<title>Getting Started</title>
	</head>
	<body>

		<script src="./js/remix/plugin/plugin_iframe.js"></script>
		<script>
			function sleep(ms) {

				return new Promise(resolve => setTimeout(resolve, ms));

			}

			ContractRequest.REQUEST_NOT_ATTEMPTED = 0 << 0;
			ContractRequest.REQUEST_RUNNING = 1 << 0;
			ContractRequest.REQUEST_SUCCESSFUL = 1 << 1;
			ContractRequest.REQUEST_FAILED = 1 << 2;
			
			function ContractRequest(address) {
				
				this.state = ContractRequest.REQUEST_NOT_ATTEMPTED;
				this.address = address;
				this.attempts = 0;
				this.lastAPIResult = "";
				
				this.lastParsedResult = {};
				this.contractData = {};
				
				// all results from the api are saved with the corresponding attempt number
				this.apiResults = [];
				
				this.saveSourcesToRemixClient = async function(remixClient, storeLocation) {
				
					let sources = {};
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						sources = this.contractData.SourceCode;
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					sources = sources.sources;
					
					let filesInContract = Object.keys(sources);
					let success = true;
					
					for(let i = 0; i < filesInContract.length; i++) {
					
						success = success & await client.fileManager.writeFile(storeLocation + "/" + this.address + "/" + filesInContract[i], sources[filesInContract[i]].content);
					
					}
					
					return success;
				
				}
				
				
				this.runRequest = async function() {
					
					try {
				
						this.state = ContractRequest.REQUEST_RUNNING;
						this.attempts++; 
						
						this.lastAPIResult = await requestForContractFromEtherscan(this);
						
						this.apiResults[this.attempts - 1] = this.lastAPIResult;
						
						if(this.lastAPIResult.failedWebRequest) {
						
							this.state = ContractRequest.REQUEST_FAILED;
						
						} else {
						
							this.lastParsedResult = JSON.parse(this.lastAPIResult.webRequestResult);
							
							if(this.lastParsedResult.status == 1) {
							
								this.contractData = this.lastParsedResult.result[0];
								
								// fix source code format. 
								//
								// if it starts with a bracket, there are multiple source code files
								if(this.contractData.SourceCode[0] == "{") {
								
									this.contractData.SourceCode = JSON.parse(this.contractData.SourceCode.substring(1, this.contractData.SourceCode.length - 1));
								
								// only one source code file. this just makes the format exactly the same as if it had multiple sources.
								} else {
									
									let temp = {};
								
									temp.sources = {};
									
									let tempSourceObj = {};
									tempSourceObj.content = this.contractData.SourceCode;
									
									temp.sources[this.contractData.ContractName + ".sol"] = tempSourceObj;
								
									this.contractData.SourceCode = temp;
								
								}
								
								// fix abi format
								this.contractData.ABI = JSON.parse(this.contractData.ABI);
							
								this.state = ContractRequest.REQUEST_SUCCESSFUL;
							
							} else {
							
								this.state = ContractRequest.REQUEST_FAILED;
							
							}
						
						}
						
					} catch(e) {
						
						this.apiResults[this.attempts - 1] = "Unexpected Error: " + e;
						
						this.state = ContractRequest.REQUEST_FAILED;
					
					}
					
					return this.state;
				
				}
				
				this.getSource = function() {
					
					let source = {};
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						source = this.contractData.SourceCode;
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return source;
				
				}
				
				this.isProxy = function() {
					
					let isProxy = false;
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						isProxy = this.contractData.Proxy != 0;
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return isProxy;
				
				}
				
				this.getAttempts = function() {
				
					return this.attempts;
				
				}
				
				this.getImplementationAddressForProxy = function() {
					
					let impl = "";
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						if(this.isProxy()) {
						
							impl = this.contractData.Implementation;
						
						} else {
						
							throw "Error: Contract is not a proxy contract.";
						
						}
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return impl;
				
				}
			
				
				this.getABI = function() {
					
					let ABI = {};
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						ABI = this.contractData.ABI;
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return ABI;
				
				}
				
			
				this.getStatusDescription = function() {
				
					let description = "";
				
					switch(this.state) {
					
						case ContractRequest.REQUEST_NOT_ATTEMPTED:
							description = "Not started";
							break;
							
						case ContractRequest.REQUEST_RUNNING:
							description = "Running";
							break;
							
						case ContractRequest.REQUEST_SUCCESSFUL:
							description = "Retrieved";
							break;
							
						case ContractRequest.REQUEST_FAILED:
							description = "Failed";
							break;
					
					}
				
					return description;
				
				}

				return this;
			
			}
			
			// The following two addresses have different structures in return results.
			
			// 0x66017d22b0f8556afdd19fc67041899eb65a21bb
			// 0xBB9bc244D798123fDe783fCc1C72d3Bb8C189413
			function requestForContractFromEtherscan(contractRequestObject) {
			
				let contractAddress = contractRequestObject.address;
				
				let returnResult = {};
				
				returnResult.failedWebRequest = false;
				returnResult.webRequestResult = "";
			
				return new Promise(function(resolve, reject) {
				
					try {
			
						// it doesn't seem possible to increase the limit beyond 20.
						let address = new URL("https://api.etherscan.io/api?module=contract&action=getsourcecode&address=" + contractAddress + "&apikey=YourApiKeyToken"); 
				
						let xmlHttp = new XMLHttpRequest();
						
						xmlHttp.onreadystatechange = function() { 
						
							if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
								
								returnResult.failedWebRequest = false;
								returnResult.webRequestResult = xmlHttp.responseText;
								
								
								resolve(returnResult);
								
							} else if(xmlHttp.readyState == 4) {
								
								returnResult.failedWebRequest = true;
								returnResult.webRequestResult = "Received a web status code that was not 200.";
								
								reject(returnResult);
								
							}
								
						}
						
						xmlHttp.addEventListener('error', function(event) {
							
							returnResult.failedWebRequest = true;
							returnResult.webRequestResult = JSON.stringify(event);
							
							reject(returnResult);
							
						});
						
						xmlHttp.open("GET", address, true); 
						xmlHttp.send(null);
						
					} catch(e) {
						
						returnResult.failedWebRequest = true;
						returnResult.webRequestResult = e;
						
						reject(returnResult);
					
					}
				
				
				});
			
			}


			function SimpleEtherscanContractClient() {
				
				this.getContract = function(address) {
				
				
				
				}
			
				return this;
			
			}


			let client = plugin_iframe.createClient();




		</script>



	<div class="container">
	<div class="card mb-3 mt-2"><div class="card-body">
	

			<div class="row mb-3"><div class="col-sm-12">
		<h6>Status</h6> <div class="d-flex align-items-center">  <small> Running</small>  	<div class="spinner-border ms-auto ml-3"  style="width: 1.2rem; height: 1.2rem;" role="status" aria-hidden="true"></div>	</div>
		</div></div>
		
				<div class="row"><div class="col-sm-12">
		<h6>Task </h6>  <small> Waiting on API cooldown</small>  		</div>
		


		
		
		</div></div>
	
	
	





</div>
	

<h6 class="mb-3 ml-1 mt-1">Import a Contract</h6>
<div class="card mb-3">
  <div class="card-header">
  
  
    <ul class="nav nav-pills card-header-pills nav-fill">
      <li class="nav-item">
        <a class="nav-link bg-secondary active btn-sm" href="#">Import</a>
      </li>
      <li class="nav-item">
        <a class="nav-link btn-sm" href="#">Settings</a>
      </li>
    </ul>
  </div>
  <div class="card-body">
  
	<p class="mb-2"><small>Enter the address of a contract on Etherscan to attempt to import it into Remix</small></p>
  
    <div class="form-group mb-2 mt-0">
    <label for="exampleFormControlSelect1">Network</label>
    <select class="form-control" id="exampleFormControlSelect1">
      <option>Ethereum Mainnet</option>
      <option>2</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
    </select>
  </div>
  
<div class="form-group">
    <label for="exampleInputEmail1">Contract Address</label>
    <input type="email" class="form-control" id="exampleInputEmail1" placeholder="0x.....">
  </div>
  
  <button type="submit" class="btn btn-primary btn-block btn-sm">Request</button>
  </div>
  
  
</div>

<h6 class="mb-3 ml-1 mt-1">Contracts for Import</h6>
	
		<div class="accordion" id="accordionExample">
  <div class="card border border-1 mb-1">
    <div class="card-header mb-0" id="headingOne">
      <div class="mb-0">
        <button class="btn btn-link btn-sm btn-block text-truncate" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
        #0001: 0x9814542f4230ab166efef3363a2d85e20d8708c7
        </button>
      </div>
    </div>

    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
      <div class="card-body">
      <div class="row mb-3"><div class="col-sm-12"><h6>Contract</h6><small>0x9814542f4230ab166efef3363a2d85e20d8708c7</small></div></div>
		<div class="row mb-3"><div class="col-sm-12">
		<h6>Status</h6><small>Not yet requested</small>
		</div></div>
				<div class="row"><div class="col-sm-12">
		<h6 class="mb-3">Storage Location</h6><small>  
		
		<textarea class="form-control" id="exampleFormControlTextarea1" rows="3" disabled>/etherscan/current_job/0x9814542f4230ab166efef3363a2d85e20d8708c7</textarea></small>
		</div></div>
		
		
		
	
		</div>
    </div>
  </div>
  
    <div class="card border border-1 mb-1">
    <div class="card-header mb-0" id="headingOne">
      <div class="mb-0">
        <button class="btn btn-link btn-sm btn-block text-truncate" type="button" data-toggle="collapse" data-target="#collapseOne2" aria-expanded="false" aria-controls="collapseOne2">
        0x9814542f4230ab166efef3363a2d85e20d8708c7
        </button>
      </div>
    </div>

    <div id="collapseOne2" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
      <div class="card-body">
	  <div class="alert alert-success" role="alert">
  <small>This contract was successfully imported!</small>
</div>
      <div class="row mb-3"><div class="col-sm-12"><h6>Contract</h6><small>0x9814542f4230ab166efef3363a2d85e20d8708c7</small></div></div>
		<div class="row"><div class="col-sm-12">
		<h6>Status</h6><small>Not yet requested</small>
		</div></div>
		
		
	
		</div>
    </div>
  </div>
    
    <div class="card border border-1 mb-3">
    <div class="card-header mb-0" id="headingOne">
      <div class="mb-0">
        <button class="btn btn-link btn-sm btn-block text-truncate" type="button" data-toggle="collapse" data-target="#collapseOne3" aria-expanded="false" aria-controls="collapseOne3">
        0x9814542f4230ab166efef3363a2d85e20d8708c7
        </button>
      </div>
    </div>

    <div id="collapseOne3" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
      <div class="card-body">
	  
	  <div class="alert alert-danger" role="alert">
	  <small>This contract's source code was not available on Etherscan</small>
</div>
	  
	  
      <div class="row mb-3"><div class="col-sm-12"><h6>Contract</h6><small>0x9814542f4230ab166efef3363a2d85e20d8708c7</small></div></div>
		<div class="row mb-3"><div class="col-sm-12">
		<h6>Status</h6><small>Not yet requested</small>
		</div></div>
		
		<button class="btn btn-sm btn-danger btn-block">Retry</button>
		
		
	
		</div>
    </div>
  </div>
  
</div>
	


<div class="card mb-3 border border-success"><div class="card-header">Import Log</div><div class="card-body">

test
</div></div>





		</div>
		
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
	</body>
</html>