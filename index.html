<!DOCTYPE html>
<html>
	<head>
		<!--- 

			bootstrap css is auto injected by the parent frame

			<link id="cssChanges" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"> 

		---->
		<meta charset="utf-8" />
		<title>Getting Started</title>
	</head>
	<body>

		<script src="./js/remix/plugin/plugin_iframe.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

		<script>
			function sleep(ms) {

				return new Promise(resolve => setTimeout(resolve, ms));

			}

			ContractRequest.REQUEST_NOT_ATTEMPTED = 0 << 0;
			ContractRequest.REQUEST_RUNNING = 1 << 0;
			ContractRequest.REQUEST_SUCCESSFUL = 1 << 1;
			ContractRequest.REQUEST_FAILED = 1 << 2;
			
			function ContractRequest(address) {
				
				this.state = ContractRequest.REQUEST_NOT_ATTEMPTED;
				this.address = address;
				this.attempts = 0;
				this.lastAPIResult = "";
				
				this.lastParsedResult = {};
				this.contractData = {};
				
				// all results from the api are saved with the corresponding attempt number
				this.apiResults = [];
				
				this.runRequest = async function() {
					
					try {
				
						this.state = ContractRequest.REQUEST_RUNNING;
						this.attempts++; 
						
						this.lastAPIResult = await requestForContractFromEtherscan(this);
						
						this.apiResults[this.attempts - 1] = this.lastAPIResult;
						
						if(this.lastAPIResult.failedWebRequest) {
						
							this.state = ContractRequest.REQUEST_FAILED;
						
						} else {
						
							this.lastParsedResult = JSON.parse(this.lastAPIResult.webRequestResult);
							
							if(this.lastParsedResult.status == 1) {
							
								this.contractData = this.lastParsedResult.result[0];
								
								// fix source code format. 
								//
								// if it starts with a bracket, there are multiple source code files
								if(this.contractData.SourceCode[0] == "{") {
								
									this.contractData.SourceCode = JSON.parse(this.contractData.SourceCode.substring(1, this.contractData.SourceCode.length - 1));
								
								// only one source code file. this just makes the format exactly the same as if it had multiple sources.
								} else {
									
									let temp = {};
								
									temp.sources = {};
									
									let tempSourceObj = {};
									tempSourceObj.content = this.contractData.SourceCode;
									
									temp.sources[this.contractData.ContractName + ".sol"] = tempSourceObj;
								
									this.contractData.SourceCode = temp;
								
								}
								
								// fix abi format
								this.contractData.ABI = JSON.parse(this.contractData.ABI);
							
								this.state = ContractRequest.REQUEST_SUCCESSFUL;
							
							} else {
							
								this.state = ContractRequest.REQUEST_FAILED;
							
							}
						
						}
						
					} catch(e) {
						
						this.apiResults[this.attempts - 1] = "Unexpected Error: " + e;
						
						this.state = ContractRequest.REQUEST_FAILED;
					
					}
					
					return this.state;
				
				}
				
				this.getSource = function() {
					
					let source = {};
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						source = this.contractData.SourceCode;
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return source;
				
				}
				
				this.isProxy = function() {
					
					let isProxy = false;
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						isProxy = this.contractData.Proxy == 1;
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return isProxy;
				
				}
				
				this.getAttempts = function() {
				
					return this.attempts;
				
				}
				
				this.getImplementationAddressForProxy = function() {
					
					let impl = "";
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						if(this.isProxy()) {
						
							impl = this.contractData.Implementation;
						
						} else {
						
							throw "Error: Contract is not a proxy contract.";
						
						}
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return impl;
				
				}
			
				
				this.getABI = function() {
					
					let ABI = {};
					
					if(this.state == ContractRequest.REQUEST_SUCCESSFUL) {
					
						ABI = this.contractData.ABI;
					
					} else {
					
						throw "Error: Contract request is not complete!";
					
					}
					
					return ABI;
				
				}
				
			
				this.getStatusDescription = function() {
				
					let description = "";
				
					switch(this.state) {
					
						case ContractRequest.REQUEST_NOT_ATTEMPTED:
							description = "Not started";
							break;
							
						case ContractRequest.REQUEST_RUNNING:
							description = "Running";
							break;
							
						case ContractRequest.REQUEST_SUCCESSFUL:
							description = "Retrieved";
							break;
							
						case ContractRequest.REQUEST_FAILED:
							description = "Failed";
							break;
					
					}
				
					return description;
				
				}

				return this;
			
			}
			
			// The following two addresses have different structures in return results.
			
			// 0x66017d22b0f8556afdd19fc67041899eb65a21bb
			// 0xBB9bc244D798123fDe783fCc1C72d3Bb8C189413
			function requestForContractFromEtherscan(contractRequestObject) {
			
				let contractAddress = contractRequestObject.address;
				
				let returnResult = {};
				
				returnResult.failedWebRequest = false;
				returnResult.webRequestResult = "";
			
				return new Promise(function(resolve, reject) {
				
					try {
			
						// it doesn't seem possible to increase the limit beyond 20.
						let address = new URL("https://api.etherscan.io/api?module=contract&action=getsourcecode&address=" + contractAddress + "&apikey=YourApiKeyToken"); 
				
						let xmlHttp = new XMLHttpRequest();
						
						xmlHttp.onreadystatechange = function() { 
						
							if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
								
								returnResult.failedWebRequest = false;
								returnResult.webRequestResult = xmlHttp.responseText;
								
								
								resolve(returnResult);
								
							} else if(xmlHttp.readyState == 4) {
								
								returnResult.failedWebRequest = true;
								returnResult.webRequestResult = "Received a web status code that was not 200.";
								
								reject(returnResult);
								
							}
								
						}
						
						xmlHttp.addEventListener('error', function(event) {
							
							returnResult.failedWebRequest = true;
							returnResult.webRequestResult = JSON.stringify(event);
							
							reject(returnResult);
							
						});
						
						xmlHttp.open("GET", address, true); 
						xmlHttp.send(null);
						
					} catch(e) {
						
						returnResult.failedWebRequest = true;
						returnResult.webRequestResult = e;
						
						reject(returnResult);
					
					}
				
				
				});
			
			}


			function SimpleEtherscanContractClient() {
				
				this.getContract = function(address) {
				
				
				
				}
			
				return this;
			
			}


			let client = plugin_iframe.createClient();




		</script>



	<div class="container">
	
	

<div class="card mb-3">
  <div class="card-header">
  
  
    <ul class="nav nav-pills card-header-pills nav-fill">
      <li class="nav-item">
        <a class="nav-link bg-secondary active" href="#">Import</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Settings</a>
      </li>
    </ul>
  </div>
  <div class="card-body">
  
	<p class="mb-2">Enter the address of a contract on Etherscan to attempt to import it into Remix</p>
  
    <div class="form-group mb-2 mt-0">
    <label for="exampleFormControlSelect1">Network</label>
    <select class="form-control" id="exampleFormControlSelect1">
      <option>Ethereum Mainnet</option>
      <option>2</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
    </select>
  </div>
  
<div class="form-group">
    <label for="exampleInputEmail1">Contract Address</label>
    <input type="email" class="form-control" id="exampleInputEmail1" placeholder="0x.....">
  </div>
  
  <button type="submit" class="btn btn-primary btn-block">Submit</button>
  </div>
  
  
</div>
	<div class="card mb-3"><div class="card-body">
	<h6>Status</h6> <div class="mb-3">Running</div>
<h6>Task</h6> Waiting on API cooldown</div></div>

	<div class="card mb-3"><div class="card-header">Status - Complete</div><div class="card-body">
<h6>Task</h6> Waiting on API cooldown</div></div>

	<div class="card mb-3"><div class="card-header">Import Progress</div><div class="card-body">
<div class="progress bg-light">
  <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
</div></div></div>

<div class="alert alert-success" role="alert">
  The contract was successfully imported!
</div>
<div class="alert alert-danger" role="alert">
	Error: This contract's source code was not available on Etherscan
</div>

<div class="card mb-3 border border-success"><div class="card-header">Import Log</div><div class="card-body">

test
</div></div>





		</div>
		
		
	</body>
</html>